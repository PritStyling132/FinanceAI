<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Forgot Password - FinanceAI</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="auth-container">
        <div class="auth-box">
            <div class="auth-header">
                <h1><i class="fas fa-chart-line"></i> FinanceAI</h1>
                <p>Reset Your Password</p>
            </div>

            <!-- Step 1: Request Reset Code -->
            <div id="requestCodeStep">
                <form id="forgotPasswordForm">
                    <div class="form-group">
                        <label class="form-label">Email Address</label>
                        <input type="email" class="form-input" id="emailInput" required placeholder="your@email.com">
                    </div>

                    <button type="submit" class="btn btn-primary btn-lg w-full">
                        <i class="fas fa-paper-plane"></i> Send Reset Code
                    </button>
                </form>

                <div style="text-align: center; margin-top: 1.5rem;">
                    <a href="/login" class="text-link">
                        <i class="fas fa-arrow-left"></i> Back to Login
                    </a>
                </div>
            </div>

            <!-- Step 2: Enter Reset Code & New Password -->
            <div id="resetPasswordStep" style="display: none;">
                <div class="alert alert-info" style="margin-bottom: 1.5rem;">
                    <i class="fas fa-info-circle"></i>
                    A 6-digit reset code has been generated. Check your terminal/console for the code.
                    <br><small>(In production, this will be sent to your email)</small>
                </div>

                <form id="resetPasswordForm">
                    <div class="form-group">
                        <label class="form-label">Email Address</label>
                        <input type="email" class="form-input" id="emailReset" readonly>
                    </div>

                    <div class="form-group">
                        <label class="form-label">6-Digit Reset Code</label>
                        <input type="text" class="form-input" id="resetCode" required placeholder="123456" maxlength="6" pattern="[0-9]{6}">
                        <small style="color: var(--text-tertiary);">Code expires in 15 minutes</small>
                    </div>

                    <div class="form-group">
                        <label class="form-label">New Password</label>
                        <input type="password" class="form-input" id="newPassword" required placeholder="Enter new password" minlength="6">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Confirm New Password</label>
                        <input type="password" class="form-input" id="confirmPassword" required placeholder="Confirm new password" minlength="6">
                    </div>

                    <button type="submit" class="btn btn-primary btn-lg w-full">
                        <i class="fas fa-check"></i> Reset Password
                    </button>
                </form>

                <div style="text-align: center; margin-top: 1.5rem;">
                    <button onclick="backToRequest()" class="text-link" style="background: none; border: none; cursor: pointer;">
                        <i class="fas fa-arrow-left"></i> Request New Code
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8000/api';
        let userEmail = '';

        // Toast notification function
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.textContent = message;
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 1rem 1.5rem;
                background: ${type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : '#3b82f6'};
                color: white;
                border-radius: 8px;
                box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                z-index: 10000;
                animation: slideIn 0.3s ease;
            `;
            document.body.appendChild(toast);
            setTimeout(() => {
                toast.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // Step 1: Request Reset Code
        document.getElementById('forgotPasswordForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const email = document.getElementById('emailInput').value;
            userEmail = email;

            try {
                const response = await fetch(`${API_BASE}/auth/forgot-password`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ email })
                });

                const data = await response.json();

                if (response.ok) {
                    showToast('Reset code sent! Check your console.', 'success');

                    // Show the reset code in console for testing
                    if (data.reset_code) {
                        console.log('='.repeat(50));
                        console.log('PASSWORD RESET CODE:', data.reset_code);
                        console.log('='.repeat(50));
                        alert(`Reset Code: ${data.reset_code}\n\n(In production, this will be sent via email)`);
                    }

                    // Move to step 2
                    document.getElementById('emailReset').value = email;
                    document.getElementById('requestCodeStep').style.display = 'none';
                    document.getElementById('resetPasswordStep').style.display = 'block';
                } else {
                    showToast(data.detail || 'Failed to send reset code', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showToast('Network error. Please try again.', 'error');
            }
        });

        // Step 2: Reset Password
        document.getElementById('resetPasswordForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const email = document.getElementById('emailReset').value;
            const resetCode = document.getElementById('resetCode').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            // Validate passwords match
            if (newPassword !== confirmPassword) {
                showToast('Passwords do not match!', 'error');
                return;
            }

            // Validate password length
            if (newPassword.length < 6) {
                showToast('Password must be at least 6 characters', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/auth/reset-password`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email,
                        reset_code: resetCode,
                        new_password: newPassword
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    showToast('Password reset successfully!', 'success');

                    // Redirect to login after 2 seconds
                    setTimeout(() => {
                        window.location.href = '/login';
                    }, 2000);
                } else {
                    showToast(data.detail || 'Failed to reset password', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showToast('Network error. Please try again.', 'error');
            }
        });

        // Back to request code step
        function backToRequest() {
            document.getElementById('requestCodeStep').style.display = 'block';
            document.getElementById('resetPasswordStep').style.display = 'none';
            document.getElementById('resetCode').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmPassword').value = '';
        }

        // Add CSS animation
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
            .alert {
                padding: 1rem;
                border-radius: 8px;
                margin-bottom: 1rem;
            }
            .alert-info {
                background: #dbeafe;
                border: 1px solid #3b82f6;
                color: #1e40af;
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>
